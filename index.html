
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TELUS - Complete Flow</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --telus-purple: #4B286D;
            --telus-green: #66CC00;
            --telus-dark: #2A2C2E;
            --telus-light-gray: #F7F7F7;
            --telus-border: #E0E0E0;
        }
body { font-family: 'Helvetica Neue', Arial, sans-serif; color: var(--telus-dark); line-height: 1.6; background: var(--telus-light-gray); }
        .layout { display: flex; flex-direction: column; height: 100vh; }
        .main-wrapper { display: flex; flex: 1; overflow: hidden; position: relative; }
        .config-panel { width: 250px; background: white; border-right: 2px solid var(--telus-border); padding: 1rem; overflow-y: auto; font-size: 0.9rem; transition: transform 0.3s ease; }
        .config-panel.collapsed { transform: translateX(-250px); }
        .config-toggle { position: absolute; left: 250px; top: 50%; transform: translateY(-50%); width: 24px; height: 60px; background: var(--telus-purple); color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.3s ease; z-index: 10; }
        .config-toggle.collapsed { left: 0; transform: translateY(-50%) rotate(180deg); }
        .config-panel h2 { color: var(--telus-purple); margin-bottom: 1rem; font-size: 1.1rem; border-bottom: 2px solid var(--telus-purple); padding-bottom: 0.5rem; }
        .config-section { margin-bottom: 1.5rem; }
        .config-section h3 { color: var(--telus-purple); font-size: 0.95rem; margin-bottom: 0.75rem; }
        .config-section h3::before { content: "‚öôÔ∏è"; margin-right: 0.5rem; }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 0.3rem; font-size: 0.8rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid var(--telus-border); border-radius: 4px; font-size: 0.85rem; }
        .apply-btn { width: 100%; padding: 0.75rem; background: var(--telus-purple); color: white; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-top: 0.75rem; }
        .event-section { background: #FFF9E6; border: 1px solid #FFD700; border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
        .details-section { background: #E8F9F0; border: 1px solid var(--telus-green); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; }
        .event-trigger-btn, .details-trigger-btn { width: 100%; padding: 0.6rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 0.5rem; font-size: 0.85rem; }
        .event-trigger-btn { background: #FFD700; color: var(--telus-dark); }
        .details-trigger-btn { background: var(--telus-green); color: white; }
        .main-content { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .container { max-width: 1200px; margin: 0 auto; }
        .line-counter-section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .line-counter { display: inline-flex; align-items: center; gap: 2rem; background: var(--telus-light-gray); padding: 1.5rem 3rem; border-radius: 50px; }
        .counter-btn { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--telus-purple); background: white; color: var(--telus-purple); font-size: 1.8rem; font-weight: bold; cursor: pointer; }
        .counter-btn:hover { background: var(--telus-purple); color: white; transform: scale(1.1); }
        .counter-btn:disabled { opacity: 0.3; }
        .counter-display { font-size: 2.5rem; font-weight: bold; color: var(--telus-purple); min-width: 80px; }
        .counter-label { font-size: 1.1rem; color: #666; margin-top: 0.5rem; }
        .plans-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; }
        .plan-card { 
            background: white; 
            border-radius: 12px; 
            padding: 2rem; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            border: 2px solid transparent; 
            position: relative; 
            min-width: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100%;
            transition: all 0.3s ease;
        }
        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-color: var(--telus-purple);
        }
        .plan-card.featured { border-color: var(--telus-green); }
        .plan-card.current-plan { border-color: var(--telus-purple); border-width: 3px; }
        .plan-card.featured:hover { border-color: var(--telus-green); }
        .plan-card.current-plan:hover { border-color: var(--telus-purple); }
        .featured-badge { position: absolute; top: -12px; right: 20px; background: var(--telus-green); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .current-plan-badge { position: absolute; top: -12px; left: 20px; background: var(--telus-purple); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; }
        .plan-name { font-size: 1.3rem; font-weight: 600; color: var(--telus-dark); margin-bottom: 1rem; }
        .plan-price-row { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--telus-border); }
        .plan-price { font-size: 1.8rem; font-weight: 600; display: flex; flex-direction: column; }
        .plan-data { font-size: 2rem; font-weight: bold; color: var(--telus-purple); text-align: right; }
        .plan-features { list-style: none; margin: 2rem 0 0 0; flex-grow: 1; }
        .plan-features li { padding: 0.6rem 0; padding-left: 1.8rem; position: relative; }
        .plan-features li:before { content: "‚úì"; position: absolute; left: 0; color: var(--telus-green); font-weight: bold; font-size: 1.2rem; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: auto; }
        .btn-primary { background-color: var(--telus-purple); color: white; }
        .btn-secondary { background-color: var(--telus-green); color: white; }
        .btn-outline { background: white; color: var(--telus-purple); border: 2px solid var(--telus-purple); }
        .warranty-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin: 2rem 0; }
        .warranty-card { background: var(--telus-light-gray); border: 2px solid var(--telus-border); border-radius: 8px; padding: 1.5rem; cursor: pointer; }
        .warranty-card.selected { border-color: var(--telus-purple); background: #F0E6F6; }
        .warranty-card h3 { color: var(--telus-purple); font-size: 1.2rem; margin-bottom: 0.5rem; }
        .warranty-price { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
        .subscriber-row { background: white; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .subscriber-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 1.5rem; transition: background-color 0.2s; }
        .subscriber-header:hover { background: #f5f5f5; }
        .subscriber-details { padding: 1.5rem; border-top: 1px solid var(--telus-border); display: none; }
        .subscriber-row.expanded .subscriber-details { display: block; }
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-bottom: 1rem; }
        .details-section { border: 1px solid var(--telus-border); padding: 1rem; border-radius: 6px; }
        .details-section h4 { color: var(--telus-purple); margin-bottom: 0.5rem; font-size: 1rem; }
        .details-list { list-style: none; }
        .details-list li { padding: 0.5rem 0; font-size: 1rem; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .details-list li:last-child { border-bottom: none; }
        .details-list li span:first-child { color: #666; }
        .details-list li span:last-child { font-weight: 600; }
        .total-row { background: var(--telus-purple); color: white; padding: 1rem; border-radius: 6px; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .total-row .total-label { font-weight: 600; }
        .total-row .total-amount { font-size: 1.2rem; font-weight: bold; }
        .expand-icon { font-size: 1.5rem; color: var(--telus-purple); transition: transform 0.3s; }
        .subscriber-badge { background: var(--telus-purple); color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: bold; font-size: 0.85rem; }
        .subscriber-plan { color: var(--telus-purple); font-weight: 600; font-size: 1.1rem; }
        .subscriber-info { display: flex; gap: 1.5rem; font-size: 0.9rem; color: #666; flex-wrap: wrap; }
        .action-icons { display: flex; gap: 0.5rem; margin-left: 1rem; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--telus-purple); background: white; color: var(--telus-purple); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .icon-btn:hover { background: var(--telus-purple); color: white; transform: scale(1.1); }
        .icon-btn.delete { border-color: #dc3545; color: #dc3545; }
        .icon-btn.delete:hover { background: #dc3545; color: white; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--telus-purple); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 400px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
        .modal-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .pagination { display: flex; align-items: center; justify-content: center; gap: 1rem; margin: 2rem 0; }
        .page-indicator { display: flex; gap: 0.5rem; }
        .page-number { width: 40px; height: 40px; border-radius: 50%; background: white; border: 2px solid var(--telus-border); color: #666; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; transition: all 0.3s; }
        .page-number.active { background: var(--telus-purple); color: white; border-color: var(--telus-purple); transform: scale(1.2); }
        .page-number:hover { border-color: var(--telus-purple); color: var(--telus-purple); }
        .page-content { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .checkout-container { max-width: 900px; margin: 0 auto; }
        .checkout-header { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .subscriber-form { background: white; border-radius: 12px; padding: 2.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .form-field { display: flex; flex-direction: column; }
        .form-field label { font-weight: 600; margin-bottom: 0.5rem; color: var(--telus-dark); }
        .form-field input, .form-field select { padding: 0.8rem; border: 2px solid var(--telus-border); border-radius: 6px; font-size: 1rem; }
        .form-field input:focus, .form-field select:focus { outline: none; border-color: var(--telus-purple); }
        .plan-summary { background: var(--telus-light-gray); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; }
        .plan-summary h3 { color: var(--telus-purple); margin-bottom: 1rem; }
        .summary-item { display: flex; justify-content: space-between; padding: 0.5rem 0; }
        .editing-info { background: #E8F4FD; border-left: 4px solid var(--telus-purple); padding: 1rem 1.5rem; margin-bottom: 2rem; border-radius: 4px; }
        .output-panel { background: white; border-left: 2px solid var(--telus-border); padding: 0.75rem; overflow-y: auto; height: 100%; width: 300px; position: fixed; top: 0; right: 0; transition: transform 0.3s ease; transform: translateX(100%); }
        .output-panel.visible { transform: translateX(0); }
        .output-panel h2 { color: var(--telus-purple); margin-bottom: 0.75rem; font-size: 1rem; border-bottom: 2px solid var(--telus-green); padding-bottom: 0.4rem; }
        .output-toggle { position: fixed; top: 50%; right: 0; width: 24px; height: 60px; background: var(--telus-purple); color: white; border: none; border-radius: 4px 0 0 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; transition: all 0.3s ease; z-index: 1000; transform: translateY(-50%); }
        .output-toggle.visible { right: 300px; }
        .output-content { display: flex; height: calc(100% - 2rem); }
        .subscribers-table-container { flex: 1; margin-right: 0.75rem; overflow-y: auto; }
        .subscribers-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.8rem; }
        .subscribers-table thead { background: var(--telus-purple); color: white; position: sticky; top: 0; }
        .subscribers-table th { padding: 0.5rem 0.3rem; text-align: left; font-weight: 600; }
        .subscribers-table td { padding: 0.5rem 0.3rem; border-bottom: 1px solid var(--telus-border); }
        .subscribers-table tbody tr.active-subscriber { background: #E8F4FD !important; border-left: 3px solid var(--telus-purple); }
        .info-badge { background: var(--telus-light-gray); padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; color: #666; margin-top: 0.2rem; display: inline-block; }
        .json-view { flex: 1; background: #f4f4f4; padding: 0.75rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.75rem; white-space: pre-wrap; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="main-wrapper">
            <aside class="config-panel" id="configPanel">
            <button class="config-toggle" onclick="toggleConfigPanel()" id="configToggle">‚óÇ</button>
            <h2>Configuration</h2>
            <div class="config-section">
                <h3>Subscriber Info</h3>
                <div class="form-group">
                    <label>Province</label>
                    <select id="provinceCode"><option value="ON">ON</option><option value="BC">BC</option></select>
                </div>
                <div class="form-group">
                    <label>City</label>
                    <input type="text" id="city" value="TORONTO">
                </div>
            </div>
            <div class="config-section">
                <h3>Transaction Info</h3>
                <div class="form-group">
                    <label>Default Number of People</label>
                    <input type="number" id="defaultPeople" value="4" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>Max Subscribers</label>
                    <input type="number" id="maxSubscribers" value="6" min="1" max="10">
                </div>
            </div>
            <button class="apply-btn" onclick="applyConfiguration()">Apply</button>
            
            <div class="event-section">
                <h3 style="margin-bottom: 1rem;">Set Active Subscriber</h3>
                <div class="form-group">
                    <label>Sequence Number</label>
                    <input type="number" id="activeSubscriber" min="1">
                </div>
                <button class="event-trigger-btn" onclick="triggerSetActiveSubscriber()">‚ö° Trigger</button>
            </div>

            <div class="details-section">
                <h3 style="margin-bottom: 1rem;">Add Subscriber Details</h3>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                    <input type="checkbox" id="bulkMode" onchange="toggleBulkMode()" style="width: auto;">
                    <label for="bulkMode" style="margin: 0;">Add to all</label>
                </div>
                <div id="singleMode">
                    <div class="form-group">
                        <label>Sequence Number</label>
                        <input type="number" id="detailsSubscriberSeq" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>SIM Type</label>
                    <select id="subscriberSimType"><option value="ESIM">ESIM</option><option value="PHYSICAL">PHYSICAL</option></select>
                </div>
                <button class="details-trigger-btn" onclick="generateAndAddDetails()">‚ö° Generate</button>
            </div>
        </aside>
        <div class="main-content">
            <div class="container">
            <div id="planSelectionView" class="page-content">
                <section class="line-counter-section" style="box-shadow: none; padding: 0; margin-bottom: 2rem;">
                    <h3 id="counterTitle">How many lines?</h3>
                    <div class="line-counter">
                        <button class="counter-btn" onclick="decrementLines()" id="decrementBtn">‚àí</button>
                        <div>
                            <div class="counter-display" id="lineCount">1</div>
                            <div class="counter-label" id="lineLabel">line</div>
                        </div>
                        <button class="counter-btn" onclick="incrementLines()" id="incrementBtn">+</button>
                    </div>
                </section>
                <section>
                    <h2 style="color: var(--telus-purple); margin-bottom: 2rem; text-align: center;">Choose Plan</h2>
                    <div class="plans-grid">
                        <div class="plan-card" id="plan-5g-complete">
                            <div class="plan-name">5G+ Complete</div>
                            <div class="plan-price-row">
                                <div class="plan-price">
                                    <div style="margin-bottom: 4px;">
                                        <span class="base-price" style="text-decoration: line-through; color: #666;">$55</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column;">
                                        <span class="discounted-price" style="color: var(--telus-green); font-size: 2rem; font-weight: 600;">$55</span>
                                        <span style="font-size: 1rem; color: #666;">/per month per line</span>
                                    </div>
                                </div>
                                <div class="plan-data" style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: baseline;">
                                        <span style="font-size: 2rem; font-weight: bold; color: var(--telus-purple);">50</span>
                                        <span style="font-size: 1rem; color: #666; margin-left: 2px;">GB</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">at 5G+ Speed</div>
                                </div>
                            </div>
                            <div class="promotion-callout" style="font-size: 1rem; color: var(--telus-green); text-align: center; margin-top: 0.75rem; padding: 0.5rem; background-color: #E6F4E6; border-radius: 4px;"></div>
                            <ul class="plan-features"><li>Canada calling</li><li>5G+ network</li></ul>
                            <p class="multi-line-discount" style="font-size: 0.9rem; color: var(--telus-green);">Eligible for multi-line discount</p>
                            <button class="btn btn-primary plan-cta" onclick="selectPlan('5g-complete-plan-id', '5G+ Complete', '$55')">Select</button>
                        </div>
                        <div class="plan-card featured" id="plan-5g-canada-us">
                            <div class="featured-badge">Popular</div>
                            <div class="plan-name">5G+ Complete Canada-US</div>
                            <div class="plan-price-row">
                                <div class="plan-price">
                                    <div style="margin-bottom: 4px;">
                                        <span class="base-price" style="text-decoration: line-through; color: #666;">$75</span>
                                    </div>
                                    <div style="display: flex; flex-direction: column;">
                                        <span class="discounted-price" style="color: var(--telus-green); font-size: 2rem; font-weight: 600;">$75</span>
                                        <span style="font-size: 1rem; color: #666;">/per month per line</span>
                                    </div>
                                </div>
                                <div class="plan-data" style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: baseline;">
                                        <span style="font-size: 2rem; font-weight: bold; color: var(--telus-purple);">75</span>
                                        <span style="font-size: 1rem; color: #666; margin-left: 2px;">GB</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">at 5G+ Speed</div>
                                </div>
                            </div>
                            <div class="promotion-callout" style="font-size: 1rem; color: var(--telus-green); text-align: center; margin-top: 0.75rem; padding: 0.5rem; background-color: #E6F4E6; border-radius: 4px;"></div>
                            <ul class="plan-features"><li>Canada & US calling</li><li>5G+ network</li></ul>
                            <p class="multi-line-discount" style="font-size: 0.9rem; color: var(--telus-green);">Eligible for multi-line discount</p>
                            <button class="btn btn-secondary plan-cta" onclick="selectPlan('5g-complete-canada-us-id', '5G+ Complete Canada-US', '$75')">Select</button>
                        </div>
                        <div class="plan-card" id="plan-5g-explore">
                            <div class="plan-name">5G+ Complete Explore</div>
                            <div class="plan-price-row">
                                <div class="plan-price">
                                    <div style="display: flex; flex-direction: column;">
                                        <span style="font-size: 2rem; font-weight: 600;">$95</span>
                                        <span style="font-size: 1rem; color: #666;">/per month per line</span>
                                    </div>
                                </div>
                                <div class="plan-data" style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="display: flex; align-items: baseline;">
                                        <span style="font-size: 2rem; font-weight: bold; color: var(--telus-purple);">100</span>
                                        <span style="font-size: 1rem; color: #666; margin-left: 2px;">GB</span>
                                    </div>
                                    <div style="font-size: 0.9rem; color: #666;">at 5G+ Speed</div>
                                </div>
                            </div>
                        <ul class="plan-features"><li>International calling</li><li>5G+ network</li></ul>
                        <p style="color: #dc3545; font-size: 0.9rem; margin-top: 1rem;">Not eligible for multi-line discount</p>
                        <button class="btn btn-primary plan-cta" onclick="selectPlan('5g-complete-explore-id', '5G+ Complete Explore', '$95')">Select</button>
                        </div>
                    </div>
                </section>
            </div>

            <div id="editPlanView" style="display: none;" class="page-content">
                <section>
                    <h2 style="color: var(--telus-purple); margin-bottom: 1rem;">Edit Plan</h2>
                    <div class="editing-info">
                        <p id="editingPlanInfo">Editing plan</p>
                    </div>
                    <section>
                        <h2 style="color: var(--telus-purple); margin-bottom: 2rem; text-align: center;">Select a Different Plan</h2>
                        <div class="plans-grid">
                            <div class="plan-card" id="edit-plan-5g-complete">
                                <div class="plan-name">5G+ Complete</div>
                                <div class="plan-price-row">
                                    <div class="plan-price">
                                        <span class="base-price" style="text-decoration: line-through; color: #666;">$55</span>
                                        <span class="discounted-price">$55</span>
                                        <span style="font-size: 1rem; color: #666;">/mo</span>
                                    </div>
                                    <div class="plan-data" style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <div>
                                            <span style="font-size: 2rem; font-weight: bold; color: var(--telus-purple);">50</span>
                                            <span style="font-size: 1.2rem; color: #666;">GB</span>
                                        </div>
                                        <div style="font-size: 0.9rem; color: #666;">at 5G+ Speed</div>
                                    </div>
                                </div>
                                <ul class="plan-features"><li>Canada calling</li><li>5G+ network</li></ul>
                                <p class="multi-line-discount" style="font-size: 0.9rem; color: var(--telus-green);">Eligible for multi-line discount</p>
                                <button class="btn btn-primary" onclick="updatePlan('5g-complete-plan-id')">Select This Plan</button>
                            </div>
                            <div class="plan-card featured" id="edit-plan-5g-canada-us">
                                <div class="featured-badge">Popular</div>
                                <div class="plan-name">5G+ Complete Canada-US</div>
                                <div class="plan-price-row">
                                    <div class="plan-price">
                                        <span class="base-price" style="text-decoration: line-through; color: #666;">$75</span>
                                        <span class="discounted-price">$75</span>
                                        <span style="font-size: 1rem; color: #666;">/mo</span>
                                    </div>
                                    <div class="plan-data" style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <div>
                                            <span style="font-size: 2rem; font-weight: bold; color: var(--telus-purple);">75</span>
                                            <span style="font-size: 1.2rem; color: #666;">GB</span>
                                        </div>
                                        <div style="font-size: 0.9rem; color: #666;">at 5G+ Speed</div>
                                    </div>
                                </div>
                                <ul class="plan-features"><li>Canada & US calling</li><li>5G+ network</li></ul>
                                <p class="multi-line-discount" style="font-size: 0.9rem; color: var(--telus-green);">Eligible for multi-line discount</p>
                                <button class="btn btn-secondary" onclick="updatePlan('5g-complete-canada-us-id')">Select This Plan</button>
                            </div>
                            <div class="plan-card" id="edit-plan-5g-explore">
                                <div class="plan-name">5G+ Complete Explore</div>
                                <div class="plan-price-row">
                                    <div class="plan-price">$95<span style="font-size: 1rem; color: #666;">/mo</span></div>
                                    <div class="plan-data" style="display: flex; flex-direction: column; align-items: flex-end;">
                                        <div>
                                            <span style="font-size: 2rem; font-weight: bold; color: var(--telus-purple);">100</span>
                                            <span style="font-size: 1.2rem; color: #666;">GB</span>
                                        </div>
                                        <div style="font-size: 0.9rem; color: #666;">at 5G+ Speed</div>
                                    </div>
                                </div>
                                <ul class="plan-features"><li>International calling</li><li>5G+ network</li></ul>
                                <p style="color: #dc3545; font-size: 0.9rem; margin-top: 1rem;">Not eligible for multi-line discount</p>
                                <button class="btn btn-primary" onclick="updatePlan('5g-complete-explore-id')">Select This Plan</button>
                            </div>
                        </div>
                    </section>
                    <button class="btn btn-outline" onclick="cancelEdit()">‚Üê Cancel</button>
                </section>
            </div>

            <div id="editWarrantyView" style="display: none;" class="page-content">
                <section>
                    <h2 style="color: var(--telus-purple); margin-bottom: 1rem;">Update Warranty</h2>
                    <p style="color: #666; margin-bottom: 2rem;" id="editWarrantySubtitle">Select warranty</p>
                    <div class="warranty-options">
                        <div class="warranty-card" id="edit-warranty-none" onclick="selectEditWarranty('none')">
                            <h3>No Warranty</h3>
                            <div class="warranty-price">$0/per month per line</div>
                        </div>
                        <div class="warranty-card" id="edit-warranty-basic" onclick="selectEditWarranty('basic-warranty-id')">
                            <h3>Basic</h3>
                            <div class="warranty-price">$10/per month per line</div>
                        </div>
                        <div class="warranty-card" id="edit-warranty-premium" onclick="selectEditWarranty('premium-warranty-id')">
                            <h3>Premium</h3>
                            <div class="warranty-price">$15/per month per line</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-outline" onclick="cancelEdit()">‚Üê Cancel</button>
                        <button class="btn btn-secondary" onclick="confirmEditWarranty()">Update Warranty</button>
                    </div>
                </section>
            </div>

            <div id="warrantySelectionView" style="display: none;" class="page-content">
                <section>
                    <h2 style="color: var(--telus-purple); margin-bottom: 1rem;">Protect Your Device</h2>
                    <p style="color: #666; margin-bottom: 2rem;" id="warrantySubtitle">Select warranty</p>
                    <div class="warranty-options">
                        <div class="warranty-card" id="warranty-none" onclick="selectWarranty('none')">
                            <h3>No Warranty</h3>
                            <div class="warranty-price">$0/mo</div>
                        </div>
                        <div class="warranty-card" id="warranty-basic" onclick="selectWarranty('basic-warranty-id')">
                            <h3>Basic</h3>
                            <div class="warranty-price">$10/mo</div>
                        </div>
                        <div class="warranty-card" id="warranty-premium" onclick="selectWarranty('premium-warranty-id')">
                            <h3>Premium</h3>
                            <div class="warranty-price">$15/mo</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-outline" onclick="backToPlans()">‚Üê Back</button>
                        <button class="btn btn-secondary" onclick="confirmWarranty()">Continue</button>
                    </div>
                </section>
            </div>

            <div id="subscriberReviewView" style="display: none;" class="page-content">
                <section style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="color: var(--telus-purple); margin-bottom: 2rem;">Review Selection</h2>
                    <div id="subscribersList"></div>
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--telus-border);">
                        <button class="btn btn-outline" id="addNewPlanBtn" onclick="addNewPlan()">+ Add Plan</button>
                        <button class="btn btn-secondary" onclick="goToCheckout()">Proceed to Checkout ‚Üí</button>
                    </div>
                </section>
            </div>

            <div id="checkoutView" style="display: none;" class="page-content">
                <div class="checkout-container">
                    <div class="checkout-header">
                        <h1>Checkout</h1>
                        <p style="color: #666;">Complete your order - Subscriber <span id="currentSubNumber">1</span> of <span id="totalSubs">3</span></p>
                    </div>

                    <div class="pagination">
                        <button class="btn btn-outline" style="padding: 0.5rem 1rem; flex: none; width: auto;" onclick="previousCheckoutPage()">‚Üê Previous</button>
                        <div class="page-indicator" id="pageIndicator"></div>
                        <button class="btn btn-outline" style="padding: 0.5rem 1rem; flex: none; width: auto;" onclick="nextCheckoutPage()">Next ‚Üí</button>
                    </div>

                    <div id="checkoutFormContainer"></div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-outline" onclick="backToReview()">‚Üê Back to Review</button>
                        <button class="btn btn-secondary" onclick="completeCheckout()">Complete Order ‚Üí</button>
                    </div>
                </div>
            </div>

            <div id="orderConfirmationView" style="display: none;" class="page-content">
                <div class="checkout-container">
                    <div class="checkout-header">
                        <h1>Order Confirmation</h1>
                        <p style="color: #666;">Thank you for your order!</p>
                    </div>
                    <div id="orderSummaryContainer"></div>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="startNewOrder()">Start New Order</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <aside class="output-panel" id="outputPanel">
            <h2>üì§ Output</h2>
            <div class="output-content">
                <div class="subscribers-table-container">
                    <table class="subscribers-table">
                        <thead><tr><th>#</th><th>Name</th><th>Plan</th><th>Warranty</th><th>Active</th></tr></thead>
                        <tbody id="subscribersTableBody"></tbody>
                    </table>
                </div>
                <div id="jsonView" class="json-view"></div>
            </div>
        </aside>
    </div>

    <button class="output-toggle" onclick="toggleOutputPanel()" id="outputToggle">‚ñ∏</button>

    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 style="color: var(--telus-purple); margin-bottom: 1rem;" id="modalTitle">Confirm</h3>
            <p id="modalMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-secondary" id="modalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        let currentLineCount=1,maxLines=6,selectedWarrantyId=null,isAddingNewPlan=false,effectiveMaxLines=6,newSubscribersStartIndex=0,currentCheckoutPage=0,editingSubscriberIndex=null,selectedEditWarrantyId=null,isEditingMode=false;
        const planMap={
            '5g-complete-plan-id':{
                name:'5G+ Complete',
                price:'$55',
                data:'50GB',
                cardId:'5g-complete',
                multiLineDiscounts: {
                    2: 5,
                    3: 7.50,
                    4: 10
                }
            },
            '5g-complete-canada-us-id':{
                name:'5G+ Complete Canada-US',
                price:'$75',
                data:'75GB',
                cardId:'5g-canada-us',
                multiLineDiscounts: {
                    2: 5,
                    3: 7.50,
                    4: 10
                }
            },
            '5g-complete-explore-id':{
                name:'5G+ Complete Explore',
                price:'$95',
                data:'100GB',
                cardId:'5g-explore'
            }
        };
        const warrantyMap={'none':{name:'No Warranty',price:'$0'},'basic-warranty-id':{name:'Basic',price:'$10'},'premium-warranty-id':{name:'Premium',price:'$15'}};
        let config={uiSubscribers:[{selectedProvinceCode:"ON",selectedCity:"TORONTO",marketSegmentId:"bb08e53d-0f4c-4486-bd0d-5c039a1809ac"}],mobilityTransactionInfo:{defaultNumberOfPeople:4,mobilityAccount:{maxSubscriberAllowed:6}}};
        let currentOutput=null;
        const firstNames=['John','Jane','Michael','Sarah','David'];
        const lastNames=['Smith','Johnson','Williams','Brown','Jones'];
        function generateName(i){return firstNames[i%firstNames.length]+i+' '+lastNames[i%lastNames.length];}
        function generatePhone(i){return 1000000000+(i*111111111);}
        
        function showToast(msg){const toast=document.createElement('div');toast.className='toast';toast.textContent=msg;document.body.appendChild(toast);setTimeout(()=>toast.remove(),3000);}
        function showConfirm(title,message,onConfirm){document.getElementById('modalTitle').textContent=title;document.getElementById('modalMessage').textContent=message;document.getElementById('confirmModal').classList.add('show');document.getElementById('modalConfirmBtn').onclick=function(){closeModal();onConfirm();}}
        function closeModal(){document.getElementById('confirmModal').classList.remove('show');}
        function toggleBulkMode(){document.getElementById('singleMode').style.display=document.getElementById('bulkMode').checked?'none':'block';}
        function generateAndAddDetails(){if(!currentOutput){showToast('Select a plan first');return;}const bulk=document.getElementById('bulkMode').checked;const sim=document.getElementById('subscriberSimType').value;if(bulk){currentOutput.uiSubscribers.forEach((s,i)=>{s.subscriberFullName=generateName(i+1);s.subscriberPhoneNumber=generatePhone(i+1);s.subscriberSimType=sim;});showToast('‚úì Details added!');}else{const seq=parseInt(document.getElementById('detailsSubscriberSeq').value);const s=currentOutput.uiSubscribers.find(x=>x.subscriberSequenceNumber===seq);if(s){s.subscriberFullName=generateName(seq);s.subscriberPhoneNumber=generatePhone(seq);s.subscriberSimType=sim;showToast('‚úì Details added!');}}showSubscriberReview(currentOutput.uiSubscribers);updateOutputPanel();}

        function updateOutputPanel(){
            const tbody=document.getElementById('subscribersTableBody');
            tbody.innerHTML='';
            if(currentOutput){
                currentOutput.uiSubscribers.forEach(s=>{
                    const p=planMap[s.ratePlanProductOfferingId];
                    const row=document.createElement('tr');
                    if(s.currentActiveSubscriberInd)row.classList.add('active-subscriber');
                    row.innerHTML='<td style="font-weight: bold; color: var(--telus-purple);">'+s.subscriberSequenceNumber+'</td><td>'+(s.firstName&&s.lastName?s.firstName+' '+s.lastName:(s.subscriberFullName||'-'))+'</td><td><strong>'+p.name+'</strong></td><td>'+(s.warrantyProductOfferingId?warrantyMap[s.warrantyProductOfferingId].name:'-')+'</td><td>'+(s.currentActiveSubscriberInd?'‚úì Yes':'No')+'</td>';
                    tbody.appendChild(row);
                });
            }
            document.getElementById('jsonView').textContent=JSON.stringify(currentOutput,null,2);
        }
        function triggerSetActiveSubscriber(){const seq=parseInt(document.getElementById('activeSubscriber').value);if(!seq||!currentOutput){showToast('Select a plan first');return;}const idx=currentOutput.uiSubscribers.findIndex(s=>s.subscriberSequenceNumber===seq);if(idx===-1){showToast('Subscriber '+seq+' not found');return;}if(document.getElementById('checkoutView').style.display==='block'){goToCheckoutPage(idx);}else if(document.getElementById('subscriberReviewView').style.display==='block'){editSubscriberFromReview(idx);}else{currentOutput.uiSubscribers.forEach(s=>s.currentActiveSubscriberInd=false);currentOutput.uiSubscribers[idx].currentActiveSubscriberInd=true;updateOutputPanel();}}
        function applyConfiguration(){config.uiSubscribers[0].selectedProvinceCode=document.getElementById('provinceCode').value;config.uiSubscribers[0].selectedCity=document.getElementById('city').value;config.mobilityTransactionInfo.defaultNumberOfPeople=parseInt(document.getElementById('defaultPeople').value);config.mobilityTransactionInfo.mobilityAccount.maxSubscriberAllowed=parseInt(document.getElementById('maxSubscribers').value);currentLineCount=config.mobilityTransactionInfo.defaultNumberOfPeople;maxLines=config.mobilityTransactionInfo.mobilityAccount.maxSubscriberAllowed;effectiveMaxLines=maxLines;updateLineDisplay();}
        
        function selectWarranty(wId){selectedWarrantyId=wId;document.querySelectorAll('#warrantySelectionView .warranty-card').forEach(c=>c.classList.remove('selected'));document.getElementById('warranty-'+(wId==='none'?'none':wId.replace('-warranty-id',''))).classList.add('selected');}
        function selectEditWarranty(wId){selectedEditWarrantyId=wId;document.querySelectorAll('#editWarrantyView .warranty-card').forEach(c=>c.classList.remove('selected'));document.getElementById('edit-warranty-'+(wId==='none'?'none':wId.replace('-warranty-id',''))).classList.add('selected');}
        function confirmWarranty(){if(!selectedWarrantyId){showToast('Select a warranty');return;}for(let i=newSubscribersStartIndex;i<currentOutput.uiSubscribers.length;i++){const s=currentOutput.uiSubscribers[i];if(selectedWarrantyId!=='none'){s.warrantyProductOfferingId=selectedWarrantyId;s.warrantyQuoteItemId='warranty-quote-'+s.subscriberSequenceNumber;}}document.getElementById('warrantySelectionView').style.display='none';document.getElementById('subscriberReviewView').style.display='block';showSubscriberReview(currentOutput.uiSubscribers);updateOutputPanel();}
        function confirmEditWarranty(){if(!selectedEditWarrantyId){showToast('Select a warranty');return;}const sub=currentOutput.uiSubscribers[editingSubscriberIndex];if(selectedEditWarrantyId!=='none'){sub.warrantyProductOfferingId=selectedEditWarrantyId;sub.warrantyQuoteItemId='warranty-quote-'+sub.subscriberSequenceNumber;}else{delete sub.warrantyProductOfferingId;delete sub.warrantyQuoteItemId;}currentOutput.uiSubscribers.forEach(s=>s.currentActiveSubscriberInd=false);editingSubscriberIndex=null;isEditingMode=false;document.getElementById('editWarrantyView').style.display='none';document.getElementById('subscriberReviewView').style.display='block';showSubscriberReview(currentOutput.uiSubscribers);updateOutputPanel();showToast('‚úì Warranty updated!');}
        function backToPlans(){document.getElementById('warrantySelectionView').style.display='none';document.getElementById('planSelectionView').style.display='block';}
        function cancelEdit(){editingSubscriberIndex=null;isEditingMode=false;currentOutput.uiSubscribers.forEach(s=>s.currentActiveSubscriberInd=false);document.getElementById('editPlanView').style.display='none';document.getElementById('editWarrantyView').style.display='none';document.getElementById('subscriberReviewView').style.display='block';showSubscriberReview(currentOutput.uiSubscribers);}
        
        function incrementLines(){if(currentLineCount<effectiveMaxLines){currentLineCount++;updateLineDisplay();}}
        function decrementLines(){if(currentLineCount>1){currentLineCount--;updateLineDisplay();}}
        function updateLineDisplay(){
            document.getElementById('lineCount').textContent=currentLineCount;
            document.getElementById('lineLabel').textContent=currentLineCount===1?'line':'lines';
            document.getElementById('decrementBtn').disabled=currentLineCount===1;
            document.getElementById('incrementBtn').disabled=currentLineCount>=effectiveMaxLines;
            document.querySelectorAll('.plan-cta').forEach(b=>{
                b.textContent=currentLineCount===1?'Select Plan':'Add for '+currentLineCount+' lines';
            });

            // Update prices based on number of lines
            document.querySelectorAll('.plan-card').forEach(card => {
                const planId = card.id.replace('plan-', '').replace('edit-plan-', '');
                const plan = Object.values(planMap).find(p => p.cardId === planId);
                const basePrice = parseInt(plan.price.replace('$', ''));
                
                // Calculate total eligible subscribers (existing + new)
                let totalEligibleCount = currentLineCount; // New lines being added
                if (currentOutput && !isAddingNewPlan) {
                    // If starting fresh (not adding to existing), don't count existing subscribers
                    totalEligibleCount = currentLineCount;
                } else if (currentOutput && isAddingNewPlan) {
                    // If adding to existing, count existing eligible subscribers
                    const existingEligibleCount = currentOutput.uiSubscribers.filter(s => 
                        planMap[s.ratePlanProductOfferingId].multiLineDiscounts
                    ).length;
                    totalEligibleCount += existingEligibleCount;
                }
                
                // Calculate discount based on total eligible subscribers
                let discount = 0;
                if (plan.multiLineDiscounts) {
                    if (totalEligibleCount >= 4) discount = plan.multiLineDiscounts[4];
                    else if (totalEligibleCount === 3) discount = plan.multiLineDiscounts[3];
                    else if (totalEligibleCount === 2) discount = plan.multiLineDiscounts[2];
                }
                
                const discountedPrice = basePrice - discount;
                const priceDisplay = card.querySelector('.plan-price');
                const promotionCallout = card.querySelector('.promotion-callout');
                
                // Show discount if there will be multiple eligible subscribers
                if (discount > 0) {
                    priceDisplay.innerHTML = `
                        <div style="margin-bottom: 4px;">
                            <span class="base-price" style="text-decoration: line-through; color: #666; font-size: 1rem;">$${basePrice}</span>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <span class="discounted-price" style="color: var(--telus-green); font-size: 2rem; font-weight: 600;">$${discountedPrice}</span>
                            <span style="font-size: 1rem; color: #666;">/per month per line</span>
                        </div>
                    `;
                    
                    promotionCallout.style.display = 'block';
                    promotionCallout.textContent = `Price includes total discounts of $${discount}`;
                    
                    // Update the multi-line discount message to show total eligible count
                    const discountMsg = card.querySelector('.multi-line-discount');
                    if (discountMsg) {
                        discountMsg.innerHTML = `Eligible for multi-line discount (-$${discount}/per month per line with ${totalEligibleCount} lines)`;
                    }
                } else {
                    priceDisplay.innerHTML = `
                        <div style="display: flex; flex-direction: column;">
                            <span class="base-price" style="font-size: 2rem; font-weight: 600;">$${basePrice}</span>
                            <span style="font-size: 1rem; color: #666;">/per month per line</span>
                        </div>
                    `;
                    
                    promotionCallout.style.display = 'none';
                    
                    // Reset the multi-line discount message
                    const discountMsg = card.querySelector('.multi-line-discount');
                    if (discountMsg) {
                        discountMsg.innerHTML = plan.multiLineDiscounts ? 'Eligible for multi-line discount' : 'Not eligible for multi-line discount';
                    }
                }
            });
        }
        
        function selectPlan(planId,planName,planPrice){if(isAddingNewPlan){const existingCount=currentOutput.uiSubscribers.length;newSubscribersStartIndex=existingCount;const nextSeq=existingCount+1;for(let i=0;i<currentLineCount;i++){const seqNum=nextSeq+i;currentOutput.uiSubscribers.push({...config.uiSubscribers[0],subscriberBusinessGroupId:'UUID-'+seqNum,subscriberSequenceNumber:seqNum,ratePlanProductOfferingId:planId,ratePlanQuoteItemId:'quote-item-'+seqNum,currentActiveSubscriberInd:false});}currentOutput.mobilityTransactionInfo.defaultNumberOfPeople=currentOutput.uiSubscribers.length;isAddingNewPlan=false;effectiveMaxLines=maxLines;}else{newSubscribersStartIndex=0;currentOutput={uiSubscribers:[],mobilityTransactionInfo:{defaultNumberOfPeople:currentLineCount,mobilityAccount:{maxSubscriberAllowed:maxLines}}};for(let i=1;i<=currentLineCount;i++){currentOutput.uiSubscribers.push({...config.uiSubscribers[0],subscriberBusinessGroupId:'UUID-'+i,subscriberSequenceNumber:i,ratePlanProductOfferingId:planId,ratePlanQuoteItemId:'quote-item-'+i,currentActiveSubscriberInd:false});}}updateOutputPanel();document.getElementById('planSelectionView').style.display='none';document.getElementById('warrantySelectionView').style.display='block';document.getElementById('warrantySubtitle').textContent='Select warranty for '+currentLineCount+' new '+(currentLineCount===1?'subscriber':'subscribers');}
        
        function editSubscriberFromReview(idx){editingSubscriberIndex=idx;isEditingMode=true;const sub=currentOutput.uiSubscribers[idx];const planInfo=planMap[sub.ratePlanProductOfferingId];currentOutput.uiSubscribers.forEach(s=>s.currentActiveSubscriberInd=false);sub.currentActiveSubscriberInd=true;document.getElementById('editingPlanInfo').textContent='Editing plan for Subscriber '+sub.subscriberSequenceNumber+' (Currently: '+planInfo.name+')';document.getElementById('subscriberReviewView').style.display='none';document.getElementById('editPlanView').style.display='block';highlightCurrentPlan(sub.ratePlanProductOfferingId);}
        
        function highlightCurrentPlan(planId){
            document.querySelectorAll('#editPlanView .plan-card').forEach(card=>{
                card.classList.remove('current-plan');
                const badge=card.querySelector('.current-plan-badge');
                if(badge)badge.remove();
            });
            const planInfo=planMap[planId];
            const card=document.getElementById('edit-plan-'+planInfo.cardId);
            if(card){
                card.classList.add('current-plan');
                const badge=document.createElement('div');
                badge.className='current-plan-badge';
                badge.textContent='Current Plan';
                card.insertBefore(badge,card.firstChild);
            }
            updateEditPlanPrices();
        }
        
        function updateEditPlanPrices() {
            const discount = calculateDiscount(currentOutput.uiSubscribers);
            document.querySelectorAll('#editPlanView .plan-card').forEach(card => {
                const planId = card.id.replace('edit-plan-', '');
                const plan = Object.values(planMap).find(p => p.cardId === planId);
                const basePrice = parseInt(plan.price.replace('$', ''));
                const discountedPrice = plan.multiLineDiscounts ? basePrice - discount : basePrice;
                const priceDisplay = card.querySelector('.plan-price');
                const promotionCallout = card.querySelector('.promotion-callout');
                
                if (plan.multiLineDiscounts && discount > 0) {
                    priceDisplay.innerHTML = `
                        <span class="base-price" style="text-decoration: line-through; color: #666;">$${basePrice}</span>
                        <span class="discounted-price" style="color: var(--telus-green);">$${discountedPrice}</span>
                        <span style="font-size: 1rem; color: #666;">/mo</span>
                    `;
                    promotionCallout.style.display = 'block';
                    promotionCallout.textContent = `Price includes total discounts of $${discount}`;
                } else {
                    priceDisplay.innerHTML = `
                        <span>$${basePrice}</span>
                        <span style="font-size: 1rem; color: #666;">/mo</span>
                    `;
                    promotionCallout.style.display = 'none';
                }
                
                const discountMsg = card.querySelector('.multi-line-discount');
                if (discountMsg) {
                    discountMsg.innerHTML = plan.multiLineDiscounts ? 
                        `Eligible for multi-line discount ${discount > 0 ? `(-$${discount}/mo with ${currentOutput.uiSubscribers.length} lines)` : ''}` : 
                        'Not eligible for multi-line discount';
                }
            });
        }
        
        function updatePlan(planId){
            if(editingSubscriberIndex!==null){
                currentOutput.uiSubscribers[editingSubscriberIndex].ratePlanProductOfferingId=planId;
                const sub=currentOutput.uiSubscribers[editingSubscriberIndex];
                document.getElementById('editPlanView').style.display='none';
                document.getElementById('editWarrantyView').style.display='block';
                document.getElementById('editWarrantySubtitle').textContent='Select warranty for Subscriber '+sub.subscriberSequenceNumber;
                if(sub.warrantyProductOfferingId){
                    selectEditWarranty(sub.warrantyProductOfferingId);
                }
                updateOutputPanel();
            }
        }
        
        function calculateDiscount(subs) {
            const eligibleSubs = subs.filter(s => planMap[s.ratePlanProductOfferingId].multiLineDiscounts);
            const eligibleCount = eligibleSubs.length;
            if (eligibleCount >= 4) return 10;
            else if (eligibleCount === 3) return 7.50;
            else if (eligibleCount === 2) return 5;
            return 0;
        }

        function showSubscriberReview(subs){
            document.getElementById('warrantySelectionView').style.display='none';
            document.getElementById('subscriberReviewView').style.display='block';
            document.getElementById('checkoutView').style.display='none';
            document.getElementById('editPlanView').style.display='none';
            document.getElementById('editWarrantyView').style.display='none';
            const list=document.getElementById('subscribersList');
            list.innerHTML='';
            const discount = calculateDiscount(subs);
            subs.forEach((s,i)=>{
                const p=planMap[s.ratePlanProductOfferingId];
                const div = document.createElement('div');
                div.className = 'subscriber-row';
                
                const basePrice = parseInt(p.price.replace('$', ''));
                const discountedPrice = p.multiLineDiscounts ? basePrice - discount : basePrice;
                
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.8rem;">
                                <span class="subscriber-badge">Subscriber ${s.subscriberSequenceNumber}</span>
                                <span class="subscriber-plan">${p.name} - ${p.multiLineDiscounts && discount > 0 ? `<span style="text-decoration: line-through;">$${basePrice}</span> $${discountedPrice}` : p.price}/per month per line</span>
                            </div>
                            <div class="subscriber-info">
                            ${s.firstName && s.lastName ? `<span>üë§ ${s.firstName} ${s.lastName}</span>` : (s.subscriberFullName ? `<span>üë§ ${s.subscriberFullName}</span>` : '')}
                            ${s.subscriberPhoneNumber ? `<span>üìû ${s.subscriberPhoneNumber}</span>` : ''}
                            ${s.phoneNumberType ? `<span>üì± ${s.phoneNumberType}</span>` : ''}
                            ${s.subscriberSimType ? `<span>üì± ${s.subscriberSimType}</span>` : ''}
                            ${s.warrantyProductOfferingId ? `<span>üõ°Ô∏è ${warrantyMap[s.warrantyProductOfferingId].name}</span>` : ''}
                            <span>üìç ${s.selectedCity}</span>
                        </div>
                            ${p.multiLineDiscounts && discount > 0 ? `<div style="color: var(--telus-green); margin-top: 0.5rem;">Multi-line discount: -$${discount}/per month per line</div>` : ''}
                            ${!p.multiLineDiscounts ? `<div style="color: #dc3545; margin-top: 0.5rem;">Not eligible for multi-line discount</div>` : ''}
                        </div>
                        <div class="action-icons">
                            <button class="icon-btn" onclick="editSubscriberFromReview(${i})">‚úèÔ∏è</button>
                            <button class="icon-btn delete" onclick="deleteSubscriber(${i})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            document.getElementById('addNewPlanBtn').style.display=(maxLines-currentOutput.uiSubscribers.length)<=0?'none':'block';
        }
        
        function deleteSubscriber(idx){showConfirm('Delete Subscriber','Delete Subscriber '+currentOutput.uiSubscribers[idx].subscriberSequenceNumber+'?',function(){currentOutput.uiSubscribers.splice(idx,1);currentOutput.uiSubscribers.forEach((s,i)=>{s.subscriberSequenceNumber=i+1;s.subscriberBusinessGroupId='UUID-'+(i+1);s.ratePlanQuoteItemId='quote-item-'+(i+1);if(s.warrantyQuoteItemId)s.warrantyQuoteItemId='warranty-quote-'+(i+1);});currentOutput.mobilityTransactionInfo.defaultNumberOfPeople=currentOutput.uiSubscribers.length;if(currentOutput.uiSubscribers.length===0){document.getElementById('subscriberReviewView').style.display='none';document.getElementById('planSelectionView').style.display='block';currentOutput=null;}else{showSubscriberReview(currentOutput.uiSubscribers);}updateOutputPanel();showToast('‚úì Subscriber deleted');});}
        
        function addNewPlan(){const existing=currentOutput.uiSubscribers.length;const remaining=maxLines-existing;if(remaining<=0)return;isAddingNewPlan=true;currentLineCount=1;effectiveMaxLines=remaining;document.getElementById('counterTitle').textContent='Add more ('+existing+' current, max '+remaining+' more)';document.getElementById('subscriberReviewView').style.display='none';document.getElementById('planSelectionView').style.display='block';updateLineDisplay();}

        function goToCheckout(){document.getElementById('subscriberReviewView').style.display='none';document.getElementById('checkoutView').style.display='block';currentCheckoutPage=0;renderCheckoutPagination();renderCheckoutForm(currentCheckoutPage);}

        function backToReview(){saveCheckoutFormData(currentCheckoutPage);document.getElementById('checkoutView').style.display='none';document.getElementById('subscriberReviewView').style.display='block';showSubscriberReview(currentOutput.uiSubscribers);}

        function renderCheckoutPagination(){const indicator=document.getElementById('pageIndicator');indicator.innerHTML='';currentOutput.uiSubscribers.forEach((sub,i)=>{const pageNum=document.createElement('div');pageNum.className='page-number'+(i===currentCheckoutPage?' active':'');pageNum.textContent=sub.subscriberSequenceNumber;pageNum.onclick=()=>goToCheckoutPage(i);pageNum.title='Subscriber '+sub.subscriberSequenceNumber;indicator.appendChild(pageNum);});document.getElementById('currentSubNumber').textContent=currentCheckoutPage+1;document.getElementById('totalSubs').textContent=currentOutput.uiSubscribers.length;}

        function generateUniqueData(index) {
            const firstName = firstNames[index % firstNames.length] + (index + 1);
            const lastName = lastNames[index % lastNames.length] + (index + 1);
            const email = `${firstName.toLowerCase()}.${lastName.toLowerCase()}@example.com`;
            const phoneNumber = String(1000000000 + (index * 111111111)).replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
            return { firstName, lastName, email, phoneNumber };
        }

        function renderCheckoutForm(index) {
            const container = document.getElementById('checkoutFormContainer');
            container.innerHTML = '';
            const sub = currentOutput.uiSubscribers[index];
            const planInfo = planMap[sub.ratePlanProductOfferingId];
            const warrantyInfo = sub.warrantyProductOfferingId ? warrantyMap[sub.warrantyProductOfferingId] : null;
            
            // Generate unique data for this subscriber
            const uniqueData = generateUniqueData(index);
            
            // Populate subscriber data if not already set
            if (!sub.firstName) sub.firstName = uniqueData.firstName;
            if (!sub.lastName) sub.lastName = uniqueData.lastName;
            if (!sub.email) sub.email = uniqueData.email;
            if (!sub.subscriberPhoneNumber) sub.subscriberPhoneNumber = uniqueData.phoneNumber;
            if (!sub.phoneNumberType) sub.phoneNumberType = 'NEW';
            if (!sub.subscriberSimType) sub.subscriberSimType = 'ESIM';

            // Calculate discount
            const discount = calculateDiscount(currentOutput.uiSubscribers);
            const basePrice = parseInt(planInfo.price.replace('$', ''));
            const discountedPrice = planInfo.multiLineDiscounts ? basePrice - discount : basePrice;

            const form = document.createElement('div');
            form.className = 'subscriber-form';
            form.innerHTML = `
                <h2>Subscriber ${sub.subscriberSequenceNumber} Details</h2>
                <div class="plan-summary">
                    <h3>Selected Services</h3>
                    <div class="summary-item">
                        <span>Plan:</span>
                        <strong>${planInfo.name} (${planInfo.data}) - 
                            ${planInfo.multiLineDiscounts && discount > 0 ? 
                                `<span style="text-decoration: line-through;">$${basePrice}</span> $${discountedPrice}` : 
                                planInfo.price}/per month per line
                        </strong>
                    </div>
                    ${warrantyInfo ? `<div class="summary-item"><span>Warranty:</span><strong>${warrantyInfo.name} - ${warrantyInfo.price}/per month per line</strong></div>` : ''}
                    ${planInfo.multiLineDiscounts && discount > 0 ? `<div class="summary-item" style="color: var(--telus-green);"><span>Multi-line discount:</span><strong>-$${discount}/per month per line</strong></div>` : ''}
                    ${!planInfo.multiLineDiscounts ? `<div class="summary-item" style="color: #dc3545;"><span>Multi-line discount:</span><strong>Not eligible</strong></div>` : ''}
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>First Name *</label>
                        <input type="text" id="firstName_${index}" value="${sub.firstName}" placeholder="Enter first name">
                    </div>
                    <div class="form-field">
                        <label>Last Name *</label>
                        <input type="text" id="lastName_${index}" value="${sub.lastName}" placeholder="Enter last name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Email Address *</label>
                        <input type="email" id="email_${index}" value="${sub.email}" placeholder="subscriber@example.com">
                    </div>
                    <div class="form-field">
                        <label>Phone Number *</label>
                        <input type="tel" id="phone_${index}" value="${sub.subscriberPhoneNumber}" placeholder="(123) 456-7890">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label>Phone Number Type *</label>
                        <select id="phoneType_${index}">
                            <option value="NEW" ${sub.phoneNumberType === 'NEW' ? 'selected' : ''}>New Phone Number</option>
                            <option value="PORT" ${sub.phoneNumberType === 'PORT' ? 'selected' : ''}>Port Phone Number</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>SIM Type</label>
                        <select id="simType_${index}">
                            <option value="ESIM" ${sub.subscriberSimType === 'ESIM' ? 'selected' : ''}>ESIM</option>
                            <option value="PHYSICAL" ${sub.subscriberSimType === 'PHYSICAL' ? 'selected' : ''}>Physical SIM</option>
                        </select>
                    </div>
                </div>
            `;
            container.appendChild(form);
            const inputs = form.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('change', () => saveCheckoutFormData(index));
            });
            updateOutputPanel();
        }

        function saveCheckoutFormData(index){const sub=currentOutput.uiSubscribers[index];sub.firstName=document.getElementById('firstName_'+index).value;sub.lastName=document.getElementById('lastName_'+index).value;sub.email=document.getElementById('email_'+index).value;sub.subscriberPhoneNumber=document.getElementById('phone_'+index).value;sub.phoneNumberType=document.getElementById('phoneType_'+index).value;sub.subscriberSimType=document.getElementById('simType_'+index).value;updateOutputPanel();}

        function goToCheckoutPage(pageIndex){if(pageIndex>=0&&pageIndex<currentOutput.uiSubscribers.length){saveCheckoutFormData(currentCheckoutPage);currentCheckoutPage=pageIndex;renderCheckoutPagination();renderCheckoutForm(currentCheckoutPage);}}

        function previousCheckoutPage(){if(currentCheckoutPage>0){goToCheckoutPage(currentCheckoutPage-1);}}

        function nextCheckoutPage(){if(currentCheckoutPage<currentOutput.uiSubscribers.length-1){goToCheckoutPage(currentCheckoutPage+1);}else{showToast('This is the last subscriber');}}

        function completeCheckout() {
            saveCheckoutFormData(currentCheckoutPage);
            let isValid = true;
            currentOutput.uiSubscribers.forEach(sub => {
                if (!sub.firstName || !sub.lastName || !sub.email || !sub.subscriberPhoneNumber || !sub.phoneNumberType) {
                    isValid = false;
                }
            });
            if (isValid) {
                showOrderConfirmation();
                console.log('Final Output:', JSON.stringify(currentOutput, null, 2));
            } else {
                showToast('Please complete all required fields');
            }
        }

        function toggleSubscriberDetails(index) {
            const rows = document.querySelectorAll('#orderSummaryContainer .subscriber-row');
            const row = rows[index];
            row.classList.toggle('expanded');
        }

        function showOrderConfirmation() {
            document.getElementById('checkoutView').style.display = 'none';
            document.getElementById('orderConfirmationView').style.display = 'block';
            const container = document.getElementById('orderSummaryContainer');
            container.innerHTML = '';

            let totalMonthlyPrice = 0;
            let totalDiscount = 0;
            const discount = calculateDiscount(currentOutput.uiSubscribers);

            currentOutput.uiSubscribers.forEach((sub, index) => {
                const planInfo = planMap[sub.ratePlanProductOfferingId];
                const warrantyInfo = sub.warrantyProductOfferingId ? warrantyMap[sub.warrantyProductOfferingId] : null;
                
                // Calculate monthly price for this subscriber
                const planPrice = parseInt(planInfo.price.replace('$', ''));
                const warrantyPrice = warrantyInfo ? parseInt(warrantyInfo.price.replace('$', '')) : 0;
                const discountedPlanPrice = planInfo.multiLineDiscounts ? planPrice - discount : planPrice;
                const subscriberTotal = discountedPlanPrice + warrantyPrice;
                totalMonthlyPrice += subscriberTotal;
                if (planInfo.multiLineDiscounts) totalDiscount += discount;

                const div = document.createElement('div');
                div.className = 'subscriber-row';
                div.innerHTML = `
                    <div class="subscriber-header" onclick="toggleSubscriberDetails(${index})">
                        <div>
                            <span class="subscriber-badge">Subscriber ${sub.subscriberSequenceNumber}</span>
                            <span class="subscriber-plan">${planInfo.name}</span>
                        </div>
                        <span class="total-amount">$${subscriberTotal}/mo</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="subscriber-details">
                        <div class="details-grid">
                            <div class="details-section">
                                <h4>Plan Details</h4>
                                <ul class="details-list">
                                    <li><span>Plan Name</span><span>${planInfo.name}</span></li>
                                    <li><span>Data</span><span>${planInfo.data}</span></li>
                                    <li><span>Monthly Price</span><span>${planInfo.multiLineDiscounts && discount > 0 ? 
                                        `<span style="text-decoration: line-through;">$${planPrice}</span> $${discountedPlanPrice}` : 
                                        `$${planPrice}`}/mo</span></li>
                                    ${planInfo.multiLineDiscounts && discount > 0 ? 
                                        `<li style="color: var(--telus-green);"><span>Multi-line Discount</span><span>-$${discount}/mo</span></li>` : ''}
                                    ${!planInfo.multiLineDiscounts ? 
                                        `<li style="color: #dc3545;"><span>Multi-line Discount</span><span>Not eligible</span></li>` : ''}
                                </ul>
                            </div>
                            <div class="details-section">
                                <h4>Warranty Details</h4>
                                <ul class="details-list">
                                    ${warrantyInfo ? `
                                        <li><span>Type</span><span>${warrantyInfo.name}</span></li>
                                        <li><span>Monthly Price</span><span>${warrantyInfo.price}/mo</span></li>
                                    ` : '<li><span>No warranty selected</span><span>$0/mo</span></li>'}
                                </ul>
                            </div>
                            <div class="details-section">
                                <h4>Subscriber Details</h4>
                                <ul class="details-list">
                                    <li><span>Name</span><span>${sub.firstName} ${sub.lastName}</span></li>
                                    <li><span>Email</span><span>${sub.email}</span></li>
                                    <li><span>Phone</span><span>${sub.subscriberPhoneNumber}</span></li>
                                    <li><span>Phone Type</span><span>${sub.phoneNumberType}</span></li>
                                    <li><span>SIM Type</span><span>${sub.subscriberSimType}</span></li>
                                    <li><span>Location</span><span>${sub.selectedCity}</span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="total-row">
                            <span class="total-label">Monthly Total</span>
                            <span class="total-amount">$${subscriberTotal}/mo</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            const eligibleCount = currentOutput.uiSubscribers.filter(s => planMap[s.ratePlanProductOfferingId].multiLineDiscounts).length;
            const ineligibleCount = currentOutput.uiSubscribers.length - eligibleCount;

            // Add overall total
            const totalDiv = document.createElement('div');
            totalDiv.style.marginTop = '2rem';
            totalDiv.style.padding = '1.5rem';
            totalDiv.style.background = 'var(--telus-purple)';
            totalDiv.style.color = 'white';
            totalDiv.style.borderRadius = '8px';
            totalDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <span style="font-size: 1.2rem; font-weight: 600;">Subtotal</span>
                    <span style="font-size: 1.5rem; font-weight: bold;">$${totalMonthlyPrice + totalDiscount}/mo</span>
                </div>
                ${totalDiscount > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; color: var(--telus-green);">
                        <div>
                            <span style="font-size: 1.2rem; font-weight: 600;">Total Multi-line Discount</span>
                            <div style="font-size: 0.9rem; margin-top: 0.2rem;">
                                (Applied to ${eligibleCount} eligible subscriber${eligibleCount !== 1 ? 's' : ''})
                                ${ineligibleCount > 0 ? ` ‚Ä¢ ${ineligibleCount} subscriber${ineligibleCount !== 1 ? 's' : ''} not eligible` : ''}
                            </div>
                        </div>
                        <span style="font-size: 1.5rem; font-weight: bold;">-$${totalDiscount}/mo</span>
                    </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; border-top: 2px solid white; padding-top: 1rem;">
                    <span style="font-size: 1.2rem; font-weight: 600;">Total Monthly Price</span>
                    <span style="font-size: 1.5rem; font-weight: bold;">$${totalMonthlyPrice}/mo</span>
                </div>
            `;
            container.appendChild(totalDiv);
        }

        function startNewOrder() {
            currentOutput = null;
            document.getElementById('orderConfirmationView').style.display = 'none';
            document.getElementById('planSelectionView').style.display = 'block';
            currentLineCount = config.mobilityTransactionInfo.defaultNumberOfPeople;
            updateLineDisplay();
        }

        function toggleConfigPanel() {
            const panel = document.getElementById('configPanel');
            const toggle = document.getElementById('configToggle');
            const isCollapsed = panel.classList.toggle('collapsed');
            toggle.textContent = isCollapsed ? '‚ñ∏' : '‚óÇ';
            toggle.classList.toggle('collapsed', isCollapsed);
        }

        function toggleOutputPanel() {
            const panel = document.getElementById('outputPanel');
            const toggle = document.getElementById('outputToggle');
            const isVisible = panel.classList.toggle('visible');
            toggle.textContent = isVisible ? '‚ñ∏' : '‚óÇ';
            toggle.classList.toggle('visible', isVisible);
        }

        currentLineCount=config.mobilityTransactionInfo.defaultNumberOfPeople;
        maxLines=config.mobilityTransactionInfo.mobilityAccount.maxSubscriberAllowed;
        effectiveMaxLines=maxLines;
        updateLineDisplay();
    </script>
</body>
</html>
